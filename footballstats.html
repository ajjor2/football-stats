<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelaajatilastot Ottelusta (Laajennetut Tiedot)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .stat-card {
            transition: transform 0.2s ease-in-out;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .additional-info-grid, .past-matches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem; 
        }
        .player-image {
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            object-fit: cover;
            margin-left: 0.75rem; 
        }
        .standings-table {
            width: 100%;
            margin-top: 1rem;
            border-collapse: collapse;
        }
        .standings-table th, .standings-table td {
            border: 1px solid #e2e8f0; /* Tailwind gray-200 */
            padding: 0.5rem 0.75rem; /* Tailwind p-2 px-3 */
            text-align: left;
            font-size: 0.875rem; /* Tailwind text-sm */
        }
        .standings-table th {
            background-color: #f8fafc; /* Tailwind gray-50 */
            font-weight: 600; /* Tailwind font-semibold */
        }
        .standings-table tr:nth-child(even) {
            background-color: #f9fafb; /* Tailwind gray-100 (hieman tummempi kuin body) */
        }
        .standings-table td.team-name {
            font-weight: 500; /* Tailwind font-medium */
        }
         .standings-table .rank { text-align: center; }
        .standings-table .number-col { text-align: right; }
       
        .past-match-item {
            font-size: 0.875rem;
            padding: 0.25rem 0;
        }
        .result-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
        }
        .win { background-color: #4ade80; } /* Tailwind green-400 */
        .draw { background-color: #facc15; } /* Tailwind yellow-400 */
        .loss { background-color: #f87171; } /* Tailwind red-400 */
        
        .head-to-head-list {
            font-size: 0.875rem;
            color: #4b5563; /* Tailwind text-gray-600 */
        }
        .head-to-head-list li {
            padding: 0.125rem 0; /* Tailwind py-0.5 */
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 sm:p-8">
    <div class="container mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Pelaajatilastot Ottelusta</h1>
            <p class="text-gray-600 mt-2">Syötä ottelun ID (esim. 3760372) hakeaksesi pelaajien kauden 2025 tilastot ja lohkon sarjataulukon.</p>
        </header>

        <div class="mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
            <input type="text" id="matchIdInput" placeholder="Syötä Match ID (esim. 3760372)" class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow">
            <button id="fetchDataButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out w-full sm:w-auto">
                Hae Tiedot
            </button>
        </div>

        <div id="loadingIndicator" class="hidden loader"></div>
        <div id="errorMessage" class="hidden text-red-600 bg-red-100 p-4 rounded-lg text-center mb-6"></div>
        
        <div id="matchInfo" class="mb-6 p-6 bg-gray-50 rounded-lg shadow">
            </div>

        <div id="groupInfoContainer" class="mb-8 p-6 bg-gray-50 rounded-lg shadow hidden">
            </div>

        <div id="playerStatsContainer" class="space-y-6">
            </div>
        
        <div id="playersNotInLineupContainer" class="mt-8">
            </div>
    </div>

    <footer class="mt-12 text-center text-gray-500 text-sm">
        <p>&copy; 2025 Pelaajatilastot Sovellus. Data by Suomen Palloliiton tulospalvelu.</p>
    </footer>

    <script>
        const matchIdInput = document.getElementById('matchIdInput');
        const fetchDataButton = document.getElementById('fetchDataButton');
        const playerStatsContainer = document.getElementById('playerStatsContainer');
        const matchInfoContainer = document.getElementById('matchInfo');
        const groupInfoContainer = document.getElementById('groupInfoContainer');
        const playersNotInLineupContainer = document.getElementById('playersNotInLineupContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessageContainer = document.getElementById('errorMessage');

        const API_BASE_URL = 'https://spl.torneopal.net/taso/rest/';
        const CURRENT_YEAR = "2025"; 
        const PREVIOUS_YEAR = (parseInt(CURRENT_YEAR) - 1).toString();


        const API_HEADERS = {
            'Accept': 'json/df8e84j9xtdz269euy3h'
        };

        fetchDataButton.addEventListener('click', async () => {
            const matchId = matchIdInput.value.trim();
            if (!matchId) {
                displayError("Syötä ottelun ID.");
                return;
            }

            clearPreviousData();
            showLoading(true);
            displayError(""); 
            let groupDataForInfo = null; 
            let teamAData = null;
            let teamBData = null;
            let originalMatchDetails = null; 

            try {
                // 1. Hae ottelutiedot
                const matchResponse = await fetch(`${API_BASE_URL}getMatch?match_id=${matchId}`, { headers: API_HEADERS });
                if (!matchResponse.ok) {
                    let errorText = `Ottelun ${matchId} hakeminen epäonnistui. Status: ${matchResponse.status}`;
                    try { const errorData = await matchResponse.json(); if (errorData && (errorData.error || errorData.message)) { errorText += ` - ${errorData.error?.message || errorData.message}`; }} catch (e) {}
                    throw new Error(errorText);
                }
                const matchData = await matchResponse.json();

                if (matchData.call && matchData.call.status !== "ok" && matchData.call.status !== "OK") {
                     throw new Error(`API-virhe ottelua ${matchId} haettaessa: ${matchData.call.status}`);
                }
                if (!matchData.match) {
                    throw new Error(`Ottelua ${matchId} ei löytynyt tai data on virheellistä.`);
                }
                originalMatchDetails = matchData.match;
                
                // 2. Hae lohkon tiedot (sisältäen ottelut H2H-vertailua varten)
                const { competition_id, category_id, group_id, team_A_id, team_B_id } = originalMatchDetails;
                if (competition_id && category_id && group_id) {
                    try {
                        const groupResponse = await fetch(`${API_BASE_URL}getGroup?competition_id=${competition_id}&category_id=${category_id}&group_id=${group_id}&matches=1`, { headers: API_HEADERS }); 
                        if (groupResponse.ok) {
                            const groupData = await groupResponse.json();
                            if (groupData.group) {
                                groupDataForInfo = groupData.group; 
                                displayGroupInfoAndStandings(groupData.group, team_A_id, team_B_id);
                            } else { console.warn("Lohkodataa ei löytynyt tai se on virheellistä:", groupData); }
                        } else { console.error(`Lohkon ${group_id} hakeminen epäonnistui. Status: ${groupResponse.status}`); }
                    } catch (groupError) { console.error("Virhe lohkon tietojen haussa:", groupError); }
                } else { console.warn("Otteludatasta puuttuu tarvittavat tiedot lohkon hakemiseksi."); }

                // 3. Hae joukkueiden täydet pelaajalistat (getTeam)
                if (team_A_id) {
                    try {
                        const teamAResponse = await fetch(`${API_BASE_URL}getTeam?team_id=${team_A_id}`, { headers: API_HEADERS });
                        if (teamAResponse.ok) teamAData = await teamAResponse.json();
                        else console.error(`Joukkueen ${team_A_id} (A) hakeminen epäonnistui. Status: ${teamAResponse.status}`);
                    } catch (e) { console.error(`Virhe joukkueen A datan haussa:`, e); }
                }
                if (team_B_id) {
                     try {
                        const teamBResponse = await fetch(`${API_BASE_URL}getTeam?team_id=${team_B_id}`, { headers: API_HEADERS });
                        if (teamBResponse.ok) teamBData = await teamBResponse.json();
                        else console.error(`Joukkueen ${team_B_id} (B) hakeminen epäonnistui. Status: ${teamBResponse.status}`);
                    } catch (e) { console.error(`Virhe joukkueen B datan haussa:`, e); }
                }
                
                // 4. Hae pelaajien tilastot (kokoonpanossa olevat)
                const playersInMatch = originalMatchDetails.lineups;
                if (!playersInMatch || playersInMatch.length === 0) {
                    playerStatsContainer.innerHTML = '<p class="text-gray-700 text-center">Ottelulle ei löytynyt pelaajatietoja.</p>';
                    displayMatchInfo(originalMatchDetails, groupDataForInfo, 0, 0);
                    if (teamAData && teamAData.team) await displayPlayersNotInLineup(teamAData.team, [], originalMatchDetails.team_A_name || 'Kotijoukkue', 'A', originalMatchDetails);
                    if (teamBData && teamBData.team) await displayPlayersNotInLineup(teamBData.team, [], originalMatchDetails.team_B_name || 'Vierasjoukkue', 'B', originalMatchDetails);
                    return;
                }
                
                const playerPromises = playersInMatch.map(playerLineupInfo => 
                    fetchAndProcessPlayerData(playerLineupInfo.player_id, playerLineupInfo.team_id, originalMatchDetails, playerLineupInfo)
                );
                
                const allPlayerStats = await Promise.all(playerPromises);
                let validPlayerStats = allPlayerStats.filter(stats => stats !== null);
                
                let totalLineupGoalsTeamA = 0;
                let totalLineupGoalsTeamB = 0;
                const teamAName = originalMatchDetails.team_A_name || 'Kotijoukkue';
                const teamBName = originalMatchDetails.team_B_name || 'Vierasjoukkue';

                validPlayerStats.forEach(player => {
                    if (player.teamIdInMatch === team_A_id) {
                        totalLineupGoalsTeamA += (player.goalsForThisSpecificTeamInSeason || 0);
                    } else if (player.teamIdInMatch === team_B_id) {
                        totalLineupGoalsTeamB += (player.goalsForThisSpecificTeamInSeason || 0);
                    }
                });
                
                displayMatchInfo(originalMatchDetails, groupDataForInfo, totalLineupGoalsTeamA, totalLineupGoalsTeamB);
                
                validPlayerStats.sort((a, b) => {
                    const getTeamSortOrder = (teamId) => {
                        if (teamId === team_A_id) return 1;
                        if (teamId === team_B_id) return 2;
                        return 3; 
                    };
                    const teamOrderA = getTeamSortOrder(a.teamIdInMatch);
                    const teamOrderB = getTeamSortOrder(b.teamIdInMatch);

                    if (teamOrderA !== teamOrderB) return teamOrderA - teamOrderB;
                    
                    const numA = parseInt(a.shirtNumber);
                    const numB = parseInt(b.shirtNumber);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        if (numA !== numB) return numA - numB;
                    } else if (!isNaN(numA)) { return -1; }
                    else if (!isNaN(numB)) { return 1; }
                    return a.name.localeCompare(b.name);
                });
                
                if (validPlayerStats.length === 0 && playersInMatch.length > 0) {
                     playerStatsContainer.innerHTML = '<p class="text-gray-700 text-center">Pelaajien tilastojen haku epäonnistui kaikille pelaajille.</p>';
                } else {
                    let currentTeamIdDisplayed = null;
                    validPlayerStats.forEach(playerFullStats => {
                        if (playerFullStats.teamIdInMatch !== currentTeamIdDisplayed) {
                            currentTeamIdDisplayed = playerFullStats.teamIdInMatch;
                            const teamHeader = document.createElement('h2');
                            teamHeader.className = 'text-2xl font-semibold text-gray-700 mt-8 mb-4 pt-4 border-t border-gray-200';
                            
                            if (currentTeamIdDisplayed === team_A_id) {
                                teamHeader.textContent = teamAName;
                            } else if (currentTeamIdDisplayed === team_B_id) {
                                teamHeader.textContent = teamBName;
                            } else {
                                teamHeader.textContent = `Joukkue ID: ${currentTeamIdDisplayed}`; 
                            }
                            playerStatsContainer.appendChild(teamHeader);
                        }
                        displayPlayerStats(playerFullStats); 
                    });
                }

                // 5. Näytä pelaajat, jotka eivät olleet kokoonpanossa
                const matchLineupPlayerIds = playersInMatch.map(p => p.player_id.toString());
                if (teamAData && teamAData.team) {
                    await displayPlayersNotInLineup(teamAData.team, matchLineupPlayerIds, teamAName, 'A', originalMatchDetails);
                }
                if (teamBData && teamBData.team) {
                    await displayPlayersNotInLineup(teamBData.team, matchLineupPlayerIds, teamBName, 'B', originalMatchDetails);
                }

            } catch (error) {
                console.error("Virhe:", error);
                if (error.message.toLowerCase().includes("failed to fetch")) {
                    displayError("Tietojen haku epäonnistui. Tämä voi johtua selaimen tietoturvarajoituksista (CORS), verkko-ongelmasta, tai siitä että API-palvelin esti pyynnön (esim. Cloudflare). Tarkista selaimen konsoli (F12) lisätietoja varten.");
                } else {
                    displayError(`Tapahtui virhe: ${error.message}`);
                }
            } finally {
                showLoading(false);
            }
        });

        function clearPreviousData() { 
            matchInfoContainer.innerHTML = '';
            groupInfoContainer.innerHTML = ''; 
            groupInfoContainer.classList.add('hidden'); 
            playerStatsContainer.innerHTML = '';
            playersNotInLineupContainer.innerHTML = '';
            errorMessageContainer.textContent = '';
            errorMessageContainer.classList.add('hidden');
        }
        function showLoading(isLoading) { 
            loadingIndicator.classList.toggle('hidden', !isLoading);
        }
        function displayError(message) { 
            errorMessageContainer.textContent = message;
            errorMessageContainer.classList.toggle('hidden', !message);
        }

        function displayMatchInfo(match, groupDataForMatchInfo, lineupGoalsA = 0, lineupGoalsB = 0) { 
            const teamAName = match.team_A_name || 'Kotijoukkue';
            const teamBName = match.team_B_name || 'Vierasjoukkue';
            const scoreA = match.fs_A !== undefined ? match.fs_A : '-';
            const scoreB = match.fs_B !== undefined ? match.fs_B : '-';

            let teamAStatsInGroup = null;
            let teamBStatsInGroup = null;

            if (groupDataForMatchInfo && groupDataForMatchInfo.teams) {
                teamAStatsInGroup = groupDataForMatchInfo.teams.find(t => t.team_id === match.team_A_id);
                teamBStatsInGroup = groupDataForMatchInfo.teams.find(t => t.team_id === match.team_B_id);
            }
            
            let goalComparisonHtml = '';
            if (teamAStatsInGroup || teamBStatsInGroup || lineupGoalsA > 0 || lineupGoalsB > 0 || (match.lineups && match.lineups.length > 0)) {
                goalComparisonHtml = `
                <div class="mt-3 mb-3 text-center">
                    <p class="text-gray-700 font-semibold text-sm mb-2">Maalivertailu (${CURRENT_YEAR}):</p>
                    <div class="grid grid-cols-2 gap-x-2 text-xs">
                        <div class="font-medium text-gray-800">${teamAName}</div>
                        <div class="font-medium text-gray-800">${teamBName}</div>
                        
                        <div class="text-gray-600">Lohkossa (TM-PM):</div>
                        <div class="text-gray-600">Lohkossa (TM-PM):</div>
                        <div class="font-semibold text-gray-700">${teamAStatsInGroup ? (teamAStatsInGroup.goals_for || 0) + '-' + (teamAStatsInGroup.goals_against || 0) : 'N/A'}</div>
                        <div class="font-semibold text-gray-700">${teamBStatsInGroup ? (teamBStatsInGroup.goals_for || 0) + '-' + (teamBStatsInGroup.goals_against || 0) : 'N/A'}</div>
                        
                        <div class="text-gray-600 mt-1">Kokoonpanon maalit:</div>
                        <div class="text-gray-600 mt-1">Kokoonpanon maalit:</div>
                        <div class="font-semibold text-gray-700">${lineupGoalsA}</div>
                        <div class="font-semibold text-gray-700">${lineupGoalsB}</div>
                    </div>
                </div>`;
            }

            let headToHeadHtml = '';
            if (groupDataForMatchInfo && groupDataForMatchInfo.matches) {
                const teamAId = match.team_A_id;
                const teamBId = match.team_B_id;
                const currentMatchId = match.match_id;

                const previousEncounters = groupDataForMatchInfo.matches.filter(m =>
                    m.match_id !== currentMatchId && 
                    ((m.team_A_id === teamAId && m.team_B_id === teamBId) || (m.team_A_id === teamBId && m.team_B_id === teamAId)) &&
                    m.status === "Played" 
                ).sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time)) 
                 .slice(0, 3);

                if (previousEncounters.length > 0) {
                    headToHeadHtml = `<div class="mt-4 pt-3 border-t border-gray-200">
                                        <h4 class="text-sm font-semibold text-gray-700 mb-1 text-center">Viimeiset keskinäiset kohtaamiset:</h4>
                                        <ul class="head-to-head-list text-center">`;
                    previousEncounters.forEach(enc => {
                        headToHeadHtml += `<li>${enc.date}: ${enc.team_A_name} ${enc.fs_A} - ${enc.fs_B} ${enc.team_B_name}</li>`;
                    });
                    headToHeadHtml += `</ul></div>`;
                }
            }
            
            matchInfoContainer.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-2 text-center">
                    ${teamAName} vs ${teamBName}
                </h2>
                <p class="text-xl text-gray-600 text-center mb-2">Tulos: ${scoreA} - ${scoreB}</p>
                ${goalComparisonHtml}
                ${headToHeadHtml}
                <p class="text-sm text-gray-500 text-center mt-3">Päivämäärä: ${match.date || 'N/A'}</p>
                <p class="text-sm text-gray-500 text-center">Sarja: ${match.category_name || 'N/A'} (${match.competition_name || 'N/A'})</p>
            `;
        }

        function displayGroupInfoAndStandings(group, currentMatchTeamAId, currentMatchTeamBId) {
            if (!group || !group.teams || group.teams.length === 0) {
                groupInfoContainer.innerHTML = '<p class="text-gray-700 text-center">Sarjataulukkoa ei löytynyt tälle lohkolle.</p>';
                groupInfoContainer.classList.remove('hidden');
                return;
            }

            const groupName = group.group_name || 'Lohko';
            const categoryName = group.category_name || 'Sarja';
            const competitionName = group.competition_name || '';

            let tableHtml = `
                <h3 class="text-xl font-semibold text-gray-700 mb-1 text-center">${categoryName} - ${groupName}</h3>
                <p class="text-sm text-gray-500 text-center mb-4">(${competitionName})</p>
                <div class="overflow-x-auto">
                    <table class="standings-table min-w-full">
                        <thead>
                            <tr>
                                <th class="rank">#</th>
                                <th class="team-name">Joukkue</th>
                                <th class="number-col">O</th>
                                <th class="number-col">V</th>
                                <th class="number-col">T</th>
                                <th class="number-col">H</th>
                                <th class="number-col">TM</th>
                                <th class="number-col">PM</th>
                                <th class="number-col">ME</th>
                                <th class="number-col">P</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const sortedTeams = [...group.teams].sort((a, b) => (parseInt(a.current_standing) || 999) - (parseInt(b.current_standing) || 999));

            sortedTeams.forEach(team => {
                let teamNameDisplay = team.team_name || 'N/A';
                if (team.team_id === currentMatchTeamAId || team.team_id === currentMatchTeamBId) {
                    teamNameDisplay = `<strong>${teamNameDisplay}</strong>`;
                }

                tableHtml += `
                    <tr>
                        <td class="rank">${team.current_standing || '-'}</td>
                        <td class="team-name">${teamNameDisplay}</td>
                        <td class="number-col">${team.matches_played || 0}</td>
                        <td class="number-col">${team.matches_won || 0}</td>
                        <td class="number-col">${team.matches_tied || 0}</td>
                        <td class="number-col">${team.matches_lost || 0}</td>
                        <td class="number-col">${team.goals_for || 0}</td>
                        <td class="number-col">${team.goals_against || 0}</td>
                        <td class="number-col">${team.goals_diff || 0}</td>
                        <td class="number-col"><strong>${team.points || 0}</strong></td>
                    </tr>
                `;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            groupInfoContainer.innerHTML = tableHtml;
            groupInfoContainer.classList.remove('hidden');
        }
        
        async function fetchAndProcessPlayerData(playerId, teamIdInMatch, fullMatchData, playerLineupInfoFromMatch) {
            const defaultPlayerInfo = {
                name: playerLineupInfoFromMatch.player_name || `Pelaaja ${playerId}`,
                shirtNumber: playerLineupInfoFromMatch.shirt_number || 'N/A',
                birthYear: 'N/A',
                teamsThisYear: 'Ei voitu hakea',
                gamesPlayedThisYear: 0, 
                gamesByTeamThisYear: {}, 
                goalsThisYear: 0,
                goalsByTeamThisYear: {},
                goalsForThisSpecificTeamInSeason: 0, 
                pastMatchesDetails: [],
                gamesPlayedLastSeason: 0, 
                goalsScoredLastSeason: 0, 
                warningsThisYear: 'N/A',
                suspensionsThisYear: 0, 
                position_fi: null, 
                nationality: null,
                img_url: null, 
                height: null, 
                weight: null, 
                finland_raised: null, 
                isCaptainInMatch: false,
                added: null, removed: null, dual_representation: null, dual_1_representation: null,
                dual_2_representation: null, overage: null, parallel_representation: null, exception_representation: null,
                teamIdInMatch: teamIdInMatch, 
                clubCrest: teamIdInMatch === fullMatchData.team_A_id ? fullMatchData.club_A_crest : fullMatchData.club_B_crest
            };

            if (!playerId || playerId.toString().startsWith("oma_maali")) { 
                console.warn(`Player ID puuttuu tai on "oma maali" (${playerId}), ohitetaan pelaaja.`);
                return null; 
            }
            try {
                const playerResponse = await fetch(`${API_BASE_URL}getPlayer?player_id=${playerId.toString()}`, { headers: API_HEADERS });

                if (!playerResponse.ok) { 
                    console.error(`Pelaajan ${playerId} hakeminen epäonnistui. Status: ${playerResponse.status}`);
                    return defaultPlayerInfo;
                }
                const playerData = await playerResponse.json();

                if (playerData.call && playerData.call.status !== "ok" && playerData.call.status !== "OK"){ 
                     console.error(`API-virhe pelaajaa ${playerId} haettaessa: ${playerData.call.status}`);
                     return {...defaultPlayerInfo, birthYear: playerData.player ? playerData.player.birthyear || 'N/A' : 'N/A', teamsThisYear: 'API-virhe'};
                }
                if (!playerData.player) { 
                    console.error(`Pelaajaa ${playerId} ei löytynyt tai data on virheellistä.`);
                     return {...defaultPlayerInfo, teamsThisYear: 'Ei löytynyt'};
                }
                
                const p = playerData.player; 

                const playerName = playerLineupInfoFromMatch.player_name || `${p.first_name || ''} ${p.last_name || ''}`.trim();
                const shirtNumber = playerLineupInfoFromMatch.shirt_number || 'N/A';
                
                let gamesPlayedThisYear = 0; 
                let goalsThisYear = 0; 
                let warningsThisYear = 0; 
                let suspensionsThisYear = 0;
                let goalsByTeamThisYear = {};
                let gamesByTeamThisYear = {}; 
                let goalsForThisSpecificTeamInSeason = 0;
                let pastMatchesDetails = [];
                let gamesPlayedLastSeason = 0;
                let goalsScoredLastSeason = 0;

                const teamNameForThisContext = (teamIdInMatch === fullMatchData.team_A_id) 
                                            ? fullMatchData.team_A_name 
                                            : (teamIdInMatch === fullMatchData.team_B_id ? fullMatchData.team_B_name : null);


                if (p.matches && Array.isArray(p.matches)) {
                    p.matches.forEach(pastMatch => { 
                        if (pastMatch.season_id === CURRENT_YEAR) {
                            gamesPlayedThisYear++;
                            const teamNameForGame = pastMatch.team_name || 'Tuntematon joukkue';
                            gamesByTeamThisYear[teamNameForGame] = (gamesByTeamThisYear[teamNameForGame] || 0) + 1; 

                            const currentMatchPlayerGoals = parseInt(pastMatch.player_goals) || 0;
                            goalsThisYear += currentMatchPlayerGoals;
                            
                            if (currentMatchPlayerGoals > 0) {
                                const teamNameForGoal = pastMatch.team_name || 'Tuntematon joukkue';
                                goalsByTeamThisYear[teamNameForGoal] = (goalsByTeamThisYear[teamNameForGoal] || 0) + currentMatchPlayerGoals;
                                
                                if (teamNameForGoal && teamNameForThisContext && teamNameForGoal === teamNameForThisContext) {
                                    goalsForThisSpecificTeamInSeason += currentMatchPlayerGoals;
                                }
                            }
                            warningsThisYear += parseInt(pastMatch.player_warnings) || 0;
                            suspensionsThisYear += parseInt(pastMatch.player_suspensions) || 0;

                            if (pastMatch.team_name && teamNameForThisContext && pastMatch.team_name === teamNameForThisContext) {
                                let opponentName = '';
                                let playerTeamScoreInPastMatch = '';
                                let opponentTeamScoreInPastMatch = '';
                                let resultIndicator = '';
                                const playerTeamIdInThisPastMatch = pastMatch.team_id; 
                                let opponentTeamIdForThisPastMatch = null;
                                
                                if (playerTeamIdInThisPastMatch === pastMatch.team_A_id) {
                                    opponentName = pastMatch.team_B_name;
                                    playerTeamScoreInPastMatch = pastMatch.fs_A;
                                    opponentTeamScoreInPastMatch = pastMatch.fs_B;
                                    opponentTeamIdForThisPastMatch = pastMatch.team_B_id;
                                } else if (playerTeamIdInThisPastMatch === pastMatch.team_B_id) {
                                    opponentName = pastMatch.team_A_name;
                                    playerTeamScoreInPastMatch = pastMatch.fs_B;
                                    opponentTeamScoreInPastMatch = pastMatch.fs_A;
                                    opponentTeamIdForThisPastMatch = pastMatch.team_A_id;
                                }

                                if (pastMatch.status === "Fixture") {
                                    resultIndicator = 'fixture';
                                    playerTeamScoreInPastMatch = ''; // Tyhjennetään tuleville peleille
                                    opponentTeamScoreInPastMatch = '';
                                } else if (pastMatch.winner_id && pastMatch.winner_id !== '-' && pastMatch.winner_id !== '0') {
                                    if (pastMatch.winner_id === playerTeamIdInThisPastMatch) {
                                        resultIndicator = 'win';
                                    } else if (opponentTeamIdForThisPastMatch && pastMatch.winner_id === opponentTeamIdForThisPastMatch) {
                                        resultIndicator = 'loss';
                                    } else { 
                                        const pScore = parseInt(playerTeamScoreInPastMatch);
                                        const oScore = parseInt(opponentTeamScoreInPastMatch);
                                        if (!isNaN(pScore) && !isNaN(oScore)) {
                                            if (pScore > oScore) resultIndicator = 'win';
                                            else if (pScore < oScore) resultIndicator = 'loss';
                                            else resultIndicator = 'draw';
                                        } else {
                                            resultIndicator = 'draw'; 
                                        }
                                    }
                                } else { 
                                     const pScoreNum = parseInt(playerTeamScoreInPastMatch);
                                     const oScoreNum = parseInt(opponentTeamScoreInPastMatch);
                                     if (!isNaN(pScoreNum) && !isNaN(oScoreNum)) {
                                         if (pScoreNum > oScoreNum) resultIndicator = 'win';
                                         else if (pScoreNum < oScoreNum) resultIndicator = 'loss';
                                         else resultIndicator = 'draw';
                                     } else {
                                         resultIndicator = 'draw'; 
                                     }
                                }

                                pastMatchesDetails.push({
                                    date: pastMatch.date,
                                    opponentName: opponentName || 'N/A',
                                    playerTeamScore: playerTeamScoreInPastMatch,
                                    opponentTeamScore: opponentTeamScoreInPastMatch,
                                    resultIndicator: resultIndicator,
                                    playerTeamNameInPastMatch: pastMatch.team_name || 'N/A',
                                    status: pastMatch.status // Lisätään status tänne
                                });
                            }
                        } else if (pastMatch.season_id === PREVIOUS_YEAR) { 
                            gamesPlayedLastSeason++;
                            goalsScoredLastSeason += parseInt(pastMatch.player_goals) || 0;
                        }
                    });
                }
                
                let teamsThisYear = [];
                if (p.teams && Array.isArray(p.teams)) {
                     p.teams.forEach(teamEntry => {
                        if (teamEntry.primary_category && 
                            ( (teamEntry.primary_category.competition_id && teamEntry.primary_category.competition_id.toLowerCase().includes(CURRENT_YEAR.substring(2))) || 
                              (teamEntry.primary_category.competition_name && teamEntry.primary_category.competition_name.includes(CURRENT_YEAR)) )
                           ) {
                            teamsThisYear.push(`${teamEntry.team_name} (${teamEntry.primary_category.category_name || 'Sarja tuntematon'})`);
                        }
                     });
                }
                 if (teamsThisYear.length === 0 && p.club_name) { 
                    teamsThisYear.push(`${p.club_name} (Joukkueen tarkka sarja ${CURRENT_YEAR} ei tiedossa)`);
                }
                if (teamsThisYear.length === 0) {
                    teamsThisYear.push("Ei joukkueita tiedossa tälle vuodelle.");
                }

                return { 
                    name: playerName, shirtNumber: shirtNumber, birthYear: p.birthyear || 'N/A', 
                    teamsThisYear: teamsThisYear.join('<br>'),
                    gamesPlayedThisYear, 
                    gamesByTeamThisYear, 
                    goalsThisYear, 
                    goalsByTeamThisYear,
                    goalsForThisSpecificTeamInSeason,
                    pastMatchesDetails,
                    gamesPlayedLastSeason, 
                    goalsScoredLastSeason, 
                    warningsThisYear, 
                    suspensionsThisYear,
                    position_fi: p.position_fi,
                    nationality: p.nationality, 
                    img_url: p.img_url,
                    height: p.height,
                    weight: p.weight,
                    finland_raised: p.finland_raised,
                    isCaptainInMatch: playerLineupInfoFromMatch.captain === "1" || playerLineupInfoFromMatch.captain === "C",
                    added: p.added, 
                    removed: p.removed, 
                    dual_representation: p.dual_representation, 
                    dual_1_representation: p.dual_1_representation,
                    dual_2_representation: p.dual_2_representation, 
                    overage: p.overage, 
                    parallel_representation: p.parallel_representation, 
                    exception_representation: p.exception_representation,
                    teamIdInMatch: teamIdInMatch, 
                    clubCrest: teamIdInMatch === fullMatchData.team_A_id ? fullMatchData.club_A_crest : fullMatchData.club_B_crest
                };

            } catch (error) { 
                console.error(`Virhe pelaajan ${playerId} tietojen käsittelyssä:`, error);
                 return {...defaultPlayerInfo, teamsThisYear: 'Virhe haussa'};
            }
        }

        function createPlayerStatCardElement(stats) {
            const card = document.createElement('div');
            card.className = 'stat-card bg-white border border-gray-200 p-5 rounded-lg shadow-lg hover:shadow-xl';
            
            let playerImageHtml = '';
            if (stats.img_url && stats.img_url !== "https://www.palloliitto.fi/sites/all/themes/palloliitto/images/no-player-image.png") {
                playerImageHtml = `<img src="${stats.img_url}" alt="Pelaajan kuva" class="player-image" onerror="this.style.display='none';">`;
            }
            
            const crestUrl = stats.clubCrest && stats.clubCrest !== "https://cdn.torneopal.net/logo/palloliitto/x.png" 
                ? stats.clubCrest 
                : 'https://placehold.co/40x40/e2e8f0/64748b?text=LOGO'; 
            
            let goalsDisplayContent = stats.goalsThisYear.toString();
            if (stats.goalsThisYear > 0 && stats.goalsByTeamThisYear && Object.keys(stats.goalsByTeamThisYear).length > 0) {
                if (Object.keys(stats.goalsByTeamThisYear).length === 1 && stats.goalsByTeamThisYear[Object.keys(stats.goalsByTeamThisYear)[0]] === stats.goalsThisYear) {
                    goalsDisplayContent = stats.goalsThisYear.toString();
                } else {
                    goalsDisplayContent = Object.entries(stats.goalsByTeamThisYear)
                        .map(([teamName, teamGoals]) => `${teamName}: ${teamGoals}`)
                        .join('<br>');
                    if (Object.keys(stats.goalsByTeamThisYear).length > 1) {
                         goalsDisplayContent += `<br><b>Yhteensä: ${stats.goalsThisYear}</b>`;
                    }
                }
            }

            let gamesPlayedDisplayContent = stats.gamesPlayedThisYear.toString(); 
            if (stats.gamesPlayedThisYear > 0 && stats.gamesByTeamThisYear && Object.keys(stats.gamesByTeamThisYear).length > 0) {
                if (Object.keys(stats.gamesByTeamThisYear).length === 1 && stats.gamesByTeamThisYear[Object.keys(stats.gamesByTeamThisYear)[0]] === stats.gamesPlayedThisYear) {
                     gamesPlayedDisplayContent = stats.gamesPlayedThisYear.toString();
                } else {
                    gamesPlayedDisplayContent = Object.entries(stats.gamesByTeamThisYear)
                        .map(([teamName, teamGames]) => `${teamName}: ${teamGames}`)
                        .join('<br>');
                    if (Object.keys(stats.gamesByTeamThisYear).length > 1) { 
                         gamesPlayedDisplayContent += `<br><b>Yhteensä: ${stats.gamesPlayedThisYear}</b>`;
                    }
                }
            }

            let additionalInfoHtml = '';
            const fieldsToShow = [
                { key: 'position_fi', label: 'Pelipaikka', defaultValue: null },
                { key: 'height', label: 'Pituus', defaultValue: '0', suffix: ' cm' },
                { key: 'weight', label: 'Paino', defaultValue: '0', suffix: ' kg' },
                { key: 'finland_raised', label: 'Suomessa kasvanut', defaultValue: '0', displayValue: 'Kyllä' },
                { key: 'added', label: 'Lisätty joukkueeseen', defaultValue: '0000-00-00 00:00:00' },
                { key: 'removed', label: 'Poistettu joukkueesta', defaultValue: '0000-00-00 00:00:00' },
                { key: 'dual_representation', label: 'Kaksoisedustus', defaultValue: '0' },
                { key: 'dual_1_representation', label: 'Kaksoisedustus (1)', defaultValue: '0' },
                { key: 'dual_2_representation', label: 'Kaksoisedustus (2)', defaultValue: '0' },
                { key: 'overage', label: 'Yli-ikäisyys', defaultValue: '0' },
                { key: 'parallel_representation', label: 'Rinnakkaisedustus', defaultValue: '' },
                { key: 'exception_representation', label: 'Poikkeuslupa', defaultValue: '0' }
            ];
            if (stats.isCaptainInMatch) { 
                fieldsToShow.splice(4, 0, { key: 'isCaptainInMatch', label: 'Kapteeni tässä ottelussa', defaultValue: false, displayValue: 'Kyllä' });
            }

            fieldsToShow.forEach(field => {
                let value = stats[field.key];
                if (value !== null && value !== undefined && value !== field.defaultValue && (field.defaultValue !== '' || value !== '')) { 
                    let displayValue = value;
                    if (field.displayValue) { 
                        if (value === true || String(value) === "1") displayValue = field.displayValue;
                        else return; 
                    }
                    if (field.suffix && String(value) !== '0') { 
                         displayValue += field.suffix;
                    }
                    additionalInfoHtml += `<div class="bg-gray-50 p-3 rounded-md"><p class="font-medium text-gray-700">${field.label}:</p><p class="text-gray-600">${displayValue}</p></div>`;
                }
            });
            
            let suspensionsHtml = '';
            if (stats.suspensionsThisYear > 0) {
                suspensionsHtml = `<div class="bg-gray-50 p-3 rounded-md sm:col-span-2"> <p class="font-medium text-gray-700">Ulosajot (${CURRENT_YEAR}):</p> <p class="text-gray-600">${stats.suspensionsThisYear}</p> </div>`;
            }

            let previousSeasonStatsHtml = '';
            if (stats.gamesPlayedLastSeason > 0 || stats.goalsScoredLastSeason > 0) {
                previousSeasonStatsHtml = `
                    <div class="bg-gray-50 p-3 rounded-md"><p class="font-medium text-gray-700">Ottelut (${PREVIOUS_YEAR}):</p><p class="text-gray-600">${stats.gamesPlayedLastSeason}</p></div>
                    <div class="bg-gray-50 p-3 rounded-md"><p class="font-medium text-gray-700">Maalit (${PREVIOUS_YEAR}):</p><p class="text-gray-600">${stats.goalsScoredLastSeason}</p></div>
                `;
            }

            let pastMatchesHtml = '';
            if (stats.pastMatchesDetails && stats.pastMatchesDetails.length > 0) {
                pastMatchesHtml += `<div class="mt-4 pt-4 border-t border-gray-200 col-span-1 sm:col-span-2">
                                        <h4 class="text-md font-semibold text-gray-700 mb-2">Pelatut ottelut tälle joukkueelle (${CURRENT_YEAR}):</h4>
                                        <ul class="list-none pl-0 space-y-1">`;
                stats.pastMatchesDetails.slice(0, 10).forEach(match => { 
                    let matchDisplay;
                    if (match.status === "Fixture") {
                        matchDisplay = `${match.date}: ${match.playerTeamNameInPastMatch} vs ${match.opponentName} (Tuleva)`;
                    } else {
                        let indicatorClass = '';
                        if (match.resultIndicator === 'win') indicatorClass = 'win';
                        else if (match.resultIndicator === 'draw') indicatorClass = 'draw';
                        else if (match.resultIndicator === 'loss') indicatorClass = 'loss';
                        matchDisplay = `<span class="result-indicator ${indicatorClass}"></span>
                                        ${match.date}: ${match.playerTeamNameInPastMatch} vs ${match.opponentName} (${match.playerTeamScore}-${match.opponentTeamScore})`;
                    }
                    pastMatchesHtml += `<li class="past-match-item">${matchDisplay}</li>`;
                });
                pastMatchesHtml += `</ul></div>`;
            }


            card.innerHTML = `
                <div class="flex items-center mb-4">
                    <img src="${crestUrl}" alt="Seuran logo" class="w-10 h-10 mr-3 rounded-full object-contain" onerror="this.src='https://placehold.co/40x40/e2e8f0/64748b?text=LOGO'; this.onerror=null;">
                    ${playerImageHtml}
                    <div class="${playerImageHtml ? '' : 'ml-3'}">
                        <h3 class="text-xl font-semibold text-blue-700">${stats.name} (#${stats.shirtNumber})</h3>
                        <p class="text-sm text-gray-500">Syntymävuosi: ${stats.birthYear}</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                    <div class="bg-gray-50 p-3 rounded-md"> <p class="font-medium text-gray-700">Joukkueet (${CURRENT_YEAR}):</p> <p class="text-gray-600">${stats.teamsThisYear || 'Ei tietoa'}</p> </div>
                    <div class="bg-gray-50 p-3 rounded-md"> <p class="font-medium text-gray-700">Pelatut ottelut (${CURRENT_YEAR}):</p> <p class="text-gray-600">${gamesPlayedDisplayContent}</p> </div>
                    <div class="bg-gray-50 p-3 rounded-md"> <p class="font-medium text-gray-700">Maalit (${CURRENT_YEAR}):</p> <p class="text-gray-600">${goalsDisplayContent}</p> </div>
                    <div class="bg-gray-50 p-3 rounded-md"> <p class="font-medium text-gray-700">Varoitukset (${CURRENT_YEAR}):</p> <p class="text-gray-600">${stats.warningsThisYear}</p> </div>
                    ${suspensionsHtml}
                    ${previousSeasonStatsHtml}
                </div>
                ${additionalInfoHtml ? `<div class="mt-4 pt-4 border-t border-gray-200"><h4 class="text-md font-semibold text-gray-700 mb-2">Lisätiedot:</h4><div class="additional-info-grid">${additionalInfoHtml}</div></div>` : ''}
                ${pastMatchesHtml} 
            `;
            return card;
        }

        function displayPlayerStats(stats) { 
            const cardElement = createPlayerStatCardElement(stats);
            playerStatsContainer.appendChild(cardElement);
        }

        async function displayPlayersNotInLineup(teamDetails, matchLineupPlayerIds, teamDisplayName, teamType, originalMatchDetails) {
            if (!teamDetails || !teamDetails.players || teamDetails.players.length === 0) {
                return; 
            }

            const playersNotInMatch = teamDetails.players.filter(player => 
                player.player_id && !matchLineupPlayerIds.includes(player.player_id.toString()) && player.inactive !== "1"
            );

            if (playersNotInMatch.length > 0) {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'mt-8 p-6 bg-gray-100 rounded-lg shadow-inner';
                
                const header = document.createElement('h3');
                header.className = 'text-xl font-semibold text-gray-800 mb-4 border-b pb-2';
                header.textContent = `Muut joukkueen pelaajat (${teamDisplayName})`;
                sectionDiv.appendChild(header);

                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'space-y-6'; 
                
                playersNotInMatch.sort((a,b) => (a.last_name || '').localeCompare(b.last_name || '') || (a.first_name || '').localeCompare(b.first_name || ''));

                const playerStatPromises = playersNotInMatch.map(async (playerFromTeam) => {
                    const playerLineupInfo = { 
                        player_id: playerFromTeam.player_id,
                        player_name: `${playerFromTeam.first_name || ''} ${playerFromTeam.last_name || ''}`.trim() || `Pelaaja ID: ${playerFromTeam.player_id}`,
                        shirt_number: playerFromTeam.shirt_number || 'N/A',
                        team_id: teamDetails.team_id, 
                        captain: '' 
                    };
                    return fetchAndProcessPlayerData(playerFromTeam.player_id, teamDetails.team_id, originalMatchDetails, playerLineupInfo);
                });

                const resolvedPlayerStatsArray = (await Promise.all(playerStatPromises)).filter(stats => stats !== null);

                if (resolvedPlayerStatsArray.length > 0) {
                    resolvedPlayerStatsArray.forEach(stats => {
                        const cardElement = createPlayerStatCardElement(stats);
                        cardsContainer.appendChild(cardElement);
                    });
                    sectionDiv.appendChild(cardsContainer);
                } else {
                    const noPlayersMsg = document.createElement('p');
                    noPlayersMsg.className = 'text-gray-600';
                    noPlayersMsg.textContent = 'Ei muita pelaajia näytettäväksi tälle joukkueelle.';
                    sectionDiv.appendChild(noPlayersMsg);
                }
                playersNotInLineupContainer.appendChild(sectionDiv);
            }
        }
    </script>
</body>
</html>
